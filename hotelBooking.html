<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hotel Booking</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <style>
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 300px;
      text-align: center;
    }
    .nav-link.dropdown-toggle::after {
      margin-left: 0.5rem;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Hotel System</a>
      <div class="d-flex">
        <input type="date" id="dateSelector" class="form-control me-2" />
        <a href="index.html" class="btn btn-outline-light me-2">Exit</a>
        <a href="pos.html" class="btn btn-outline-light me-2">POS</a>
        <a href="hotelBooking.html" class="btn btn-outline-light me-2">Hotel Booking</a>
        <div class="dropdown">
          <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">ADMIN</button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="viewHistory">History</a></li>
            <li><a class="dropdown-item" href="#" id="viewUpcoming">Upcoming</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="container mt-3">
    <button class="btn btn-primary mb-3" onclick="showBookingForm()">New Booking</button>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Room</th>
          <th>Status</th>
          <th>Name</th>
          <th>Bill</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="bookingTable"></tbody>
    </table>
  </div>

  <!-- New Booking Modal -->
  <div id="bookingModal" class="modal">
    <div class="modal-content">
      <h4>New Booking</h4>
      <input id="firstName" placeholder="First Name" class="form-control mb-2" />
      <input id="lastName" placeholder="Last Name" class="form-control mb-2" />
      <input id="guests" type="number" placeholder="Guests" class="form-control mb-2" />
      <input id="arrival" type="date" class="form-control mb-2" />
      <input id="departure" type="date" class="form-control mb-2" />
      <div class="form-check mb-2">
        <input id="tab" type="checkbox" class="form-check-input" />
        <label for="tab" class="form-check-label">Add £50 Tab Deposit</label>
      </div>
      <div class="d-flex gap-2 mb-2">
        <select id="roomNumber" class="form-select"></select>
        <button id="findRoomBtn" class="btn btn-secondary">Find Room</button>
      </div>
      <button class="btn btn-success" onclick="confirmBooking()">Confirm</button>
      <button class="btn btn-danger" onclick="closeModal('bookingModal')">Close</button>
    </div>
  </div>

  <!-- Check-in Clean Prompt -->
  <div id="cleanCheckPopup" class="modal">
    <div class="modal-content">
      <h5>Room Cleaning Status</h5>
      <p>Is the room clean?</p>
      <button id="cleanYes" class="btn btn-success">Yes</button>
      <button id="cleanNo" class="btn btn-danger">No</button>
    </div>
  </div>

  <script>
    let bookings = JSON.parse(localStorage.getItem("bookings") || "[]");
    let currentBookingId = null;

    function showBookingForm() {
      document.getElementById("bookingModal").style.display = "flex";
      const roomSelect = document.getElementById("roomNumber");
      roomSelect.innerHTML = "";
      for (let i = 101; i <= 106; i++) {
        roomSelect.innerHTML += `<option value="${i}">${i}</option>`;
      }
    }

    function closeModal(id) {
      document.getElementById(id).style.display = "none";
    }

    function confirmBooking() {
      const fname = document.getElementById("firstName").value;
      const lname = document.getElementById("lastName").value;
      const guests = +document.getElementById("guests").value;
      const arrival = document.getElementById("arrival").value;
      const departure = document.getElementById("departure").value;
      const room = document.getElementById("roomNumber").value;
      const tab = document.getElementById("tab").checked;
      const id = Date.now().toString();
      
      if (!fname || !lname || !arrival || !departure || !room) return;

      bookings.push({ id, fname, lname, guests, arrival, departure, room, tab, checkedIn: false, checkedOut: false, charges: tab ? 50 : 0, clean: true });
      localStorage.setItem("bookings", JSON.stringify(bookings));
      closeModal("bookingModal");
      renderBookings();
    }

    function renderBookings() {
      const table = document.getElementById("bookingTable");
      const day = document.getElementById("dateSelector").value;
      table.innerHTML = "";
      bookings.forEach(b => {
        if (day >= b.arrival && day <= b.departure) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${b.room}</td>
            <td><span class="badge ${b.clean ? 'bg-success' : 'bg-danger'}">${b.clean ? 'Clean' : 'Dirty'}</span></td>
            <td>${b.fname} ${b.lname}</td>
            <td>£${b.charges.toFixed(2)}</td>
            <td>
              ${!b.checkedIn ? `<button class="btn btn-primary btn-sm" onclick="promptClean('${b.id}')">Check In</button>` :
                !b.checkedOut ? `<button class="btn btn-warning btn-sm" onclick="checkout('${b.id}')">Checkout</button>` :
                '<span class="text-muted">Checked Out</span>'}
            </td>`;
          table.appendChild(row);
        }
      });
    }

    function promptClean(id) {
      currentBookingId = id;
      document.getElementById("cleanCheckPopup").style.display = "flex";
    }

    document.getElementById("cleanYes").onclick = () => {
      const booking = bookings.find(b => b.id === currentBookingId);
      booking.checkedIn = true;
      localStorage.setItem("bookings", JSON.stringify(bookings));
      closeModal("cleanCheckPopup");
      renderBookings();
    };

    document.getElementById("cleanNo").onclick = () => {
      closeModal("cleanCheckPopup");
    };

    function checkout(id) {
      const booking = bookings.find(b => b.id === id);
      let extra = 0;
      const storedPOS = JSON.parse(localStorage.getItem("posCharges") || "[]");
      storedPOS.forEach(p => {
        if (p.room === booking.room && !p.processed) {
          booking.charges += p.amount;
          p.processed = true;
        }
      });
      localStorage.setItem("posCharges", JSON.stringify(storedPOS));
      booking.checkedOut = true;
      localStorage.setItem("bookings", JSON.stringify(bookings));
      renderBookings();
    }

    document.getElementById("dateSelector").onchange = renderBookings;
    document.getElementById("findRoomBtn").onclick = () => {
      const arrival = document.getElementById("arrival").value;
      const departure = document.getElementById("departure").value;
      for (let i = 101; i <= 106; i++) {
        const overlap = bookings.some(b => b.room == i && !(b.departure < arrival || b.arrival > departure));
        if (!overlap) {
          document.getElementById("roomNumber").value = i;
          return;
        }
      }
      alert("No available rooms.");
    };

    window.onload = () => {
      const today = new Date().toISOString().split("T")[0];
      document.getElementById("dateSelector").value = today;
      renderBookings();
    };
  </script>
</body>
</html>
